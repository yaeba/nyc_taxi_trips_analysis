---
title: "MAST30034 Assignment 1"
author: "Xuanken Tay"
date: "August 6, 2019"
output: 
  html_document:
    number_sections: true
    toc: true
    fig_width: 7
    fig_height: 4.5
    theme: readable
    highlights: tango
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```


# Introduction

This is an introduction. **Bold**. *Italic*, `command`

## New York City Taxi & Limousine Commission (TLC) Service Trip Record Data

## TLC Taxi Zone Data

- [Taxi Zone Lookup Table](https://s3.amazonaws.com/nyc-tlc/misc/taxi+_zone_lookup.csv): a lookup table that contains TLC taxi zone location IDs, location names and corresponding boroughs for each ID is used to convert ...  

- [Taxi Zone Shapefile](https://s3.amazonaws.com/nyc-tlc/misc/taxi_zones.zip): a shapefile containing the boundaries for the taxi zones for use in geospatial visualisation.  

## New York Central Park Weather Data

Central Park weather data comes from [National Climatic Data Center](https://www.ncdc.noaa.gov/). Contains daily weather observation. Columns are [average daily wind speed(mile/hr), precipitation(inch), snowfall (inch), snow depth (inch), maximum temperature (fahrenheit), minimum temperature (fahrenheit]


## Another external data


## Load libraries and helper functions

Put all libraries and descrpitions here

```{r libraries}
library(tidyverse)
library(data.table)
library(ggmap)
library(tmap)
library(tmaptools)
library(rgdal)
library(lubridate)
```

Function  

```{r helper_func}
read_taxi_data <- function(months, cols) {
  dfs <- list()
  for (i in sprintf("%02d", months)) {
    fname <- paste0("data/green_tripdata_2015-", i, ".csv.gz")
    dfs[[i]] <- fread(fname, fill=TRUE, select=cols, showProgress=FALSE)
  }
  rbindlist(dfs)
}

```


----------------------------------------------------------------------------------------------------------

# Data Selection

Green taxi data has been chosen for this analysis. Because ... and less space on disk.

## Period Selection

I selected data from month.... because ... (summer and winter)
```{r}
year <- 2015
# summer_months <- c(6, 7, 8)
# winter_months <- c(12, 1, 2)

summer_months <- c(7)
winter_months <- c(1)
```

## Attribute Selection

Attributes ... have been chosen for analysis.

```{r}
# columns needed for the analysis
cols_selected <- c("lpep_pickup_datetime", "Lpep_dropoff_datetime",
                   "Trip_distance", "Tip_amount", "Total_amount",
                   "Passenger_count", "Payment_type", 
                   "Pickup_latitude", "Pickup_longitude",
                   "Dropoff_latitude", "Dropoff_longitude",
                   "RateCodeID")
```


----------------------------------------------------------------------------------------------------------

# Data Preparation

The NYC taxi trip data has been processed minimally from the shell. The only alteration done on the data with unix was just compressing it to gzipped format. This step was performed to reduce the disk space required to hold the data.  

The summer and winter data were then read into R separately. Thanks to "data.table" package, reading and subsequent binding of datasets can be done faster and more efficiently.
```{r summer_and_winter}
summer_trips <- read_taxi_data(summer_months, cols_selected)
winter_trips <- read_taxi_data(winter_months, cols_selected)

cat(paste0("Number of records in summer data: ", dim(summer_trips)[1],
           "\n",
            "Number of records in winter data: ", dim(winter_trips)[1])
)
```

The trips data were then merged together to give us a dataframe to work on for the analysis. An extra attribute that captures the duration of all trips could also be added to the data by computing the time difference between pickup and dropoff as recorded by taximeter.

```{r merge_summer_winter}
# bind summer and winter data together
trips_data <- rbindlist(list(summer=summer_trips, winter=winter_trips),
                        idcol="Season")

# to save space
rm(summer_trips, winter_trips)

# convert to date objects and find difference
setnames(trips_data, 
         old=c("lpep_pickup_datetime", "Lpep_dropoff_datetime"),
         new=c("Pickup_datetime", "Dropoff_datetime"))
trips_data[, Pickup_datetime := ymd_hms(Pickup_datetime)]
trips_data[, Dropoff_datetime := ymd_hms(Dropoff_datetime)]
trips_data[, Trip_duration := difftime(Dropoff_datetime,
                                       Pickup_datetime,
                                       units="mins") %>% as.numeric() %>% round(digits=1)]

```

Taxi zones location and geospatial information were also read in to assist our analysis on the trips data.  

External data (weather), filter to months

```{r lookup_shapefile}
zones_lookup <- read_csv("data/taxi+_zone_lookup.csv", col_types="iccc")
taxi_zones <- readOGR(dsn = "data/taxi_zones/taxi_zones.shp", verbose=FALSE)
taxi_zones$id <- row.names(taxi_zones)

weather <- read_csv("data/central_park_weather.csv", col_types="ccDddddii") %>%
  filter(month(DATE) %in% c(summer_months, winter_months)) %>%
  mutate(AVG_T = (TMAX + TMIN) / 2) %>%
  select(-c("STATION", "NAME", "TMAX", "TMIN"))
```


Assuming the taxi trip data contains no duplicate records for any single trip, we can then continue with data cleansing and preprocessing. 

## Data Cleansing

It is important to clean the data as removing incorrect information can improve the data quality and in doing so, increases overal productivity. Note that here I cleaned only the taxi trip data as it is ultimately the one to be analysed. Any other data such as the zone information or weather data from external sources to aid in downstream analysis will be assumed to be clean.  

The trips data has been checked and none of rows - with chosen attributes contains missing value. It is great because we do not have to worry about losing useful data or doing missing value imputation.


```{r missing_val}
cat(paste(
  "Number of rows with missing value(s) in trips data:",
  sum(rowSums(is.na(trips_data)))
  )
)
```

Next the data was checked to remove any abnormal or wrong records. This step is important as it ensures the data is correct, consistent and useable by identifying any errors or inaccurate information in the data. Since manually correcting the data requires huge amount of time and relevant domain knowledge, I decided to simply remove trip records that contain any obvious errors.  

Along with some defined "errors", we also want to remove outliers in the data since they are so rare, uninteresting and may not contribute much to the downstream analysis. Briefly, dirtyness in the trips records have been checked and filtered out according to the follwing criteria:  
- $Passenger\_count = 0$ or $> 7$ (Number of passenger in the vehicle)  
- $Pickup/Dropoff\_latitude \notin (39, 42)$ or $Pickup/Dropoff\_longitutde \notin (-76, -72)$  
  * Pickup or dropoff outside of New York City, only trips within New York are of interest, exact location of New York is [40°39′40″N 73°56′38″W](https://en.wikipedia.org/wiki/New_York_City)  
- $Tip\_amount < 0$ or $> 200 dollars$  
- $Total\_amount <= 0$ or $> 300 dollars$  
- $Trip\_duration < 1 minute$ $> 12 hours$  
- $Trip\_distance <= 0$ or $> 100 miles$  
- $Payment\_type$ of neither credit card nor cash  

The thresholds have been chosen after conducting brief analysis on descriptive statistics on those variables.  
```{r data_cleaning}
n_before <- dim(trips_data)[1]

# do filtering
trips_data <- trips_data[
  !(Passenger_count == 0 | Passenger_count > 7 |
      Pickup_latitude < 39 | Pickup_latitude > 42 |
      Pickup_longitude < -76 | Pickup_longitude > -72 |
      Dropoff_latitude < 39 | Dropoff_latitude > 42 |
      Dropoff_longitude < -76 | Dropoff_longitude > -72 |
      Tip_amount < 0 | Tip_amount > 200 |
      Total_amount <= 0 | Total_amount > 300 |
      Trip_duration < 1 | Trip_duration > (12 * 60) |
      Trip_distance <= 0 | Trip_distance > 100 |
      Payment_type > 2),
]

n_after <- dim(trips_data)[1]

cat(paste(
  "Removed", n_before - n_after, "rows from the trips data")
)
```

Now the trips data has been cleaned, we are left with higher quality information, we can now continue with data preprocessing for the analysis.

## Data Preprocessing

Merge taxi_zones data with zones_lookup$Service zone.  Also find intersect between location points and taxi zones
```{r merge_intersect}
# merge zone information with taxi service zone in lookup table
taxi_zones@data <- taxi_zones@data %>%
  left_join(zones_lookup %>% 
              select(-LocationID, -Borough) %>%
              unique(), 
            by=c('zone' = 'Zone'))

# reproject to commonly used CRS
taxi_zones <- spTransform(taxi_zones, CRS("+init=epsg:4326"))

# find intersect between trip locations and taxi zones
trips_data[, 
  Pickup_location := SpatialPointsDataFrame(coords=trips_data[, c('Pickup_longitude', 'Pickup_latitude')],
                                            data=trips_data,
                                            proj4string=CRS(proj4string(taxi_zones))) %>%
    over(taxi_zones) %>%
    pull(OBJECTID)]

trips_data[, 
  Dropoff_location := SpatialPointsDataFrame(coords=trips_data[, c('Dropoff_longitude', 'Dropoff_latitude')],
                                             data=trips_data,
                                             proj4string=CRS(proj4string(taxi_zones))) %>%
    over(taxi_zones) %>%
    pull(OBJECTID)]


# some trips may not fall in known taxi zones
trips_data <- na.omit(trips_data)
```


We will consider airport taxi rides as trips that terminated at the 3 NYC area airports: John F. Kennedy International Airport (JFK), LaGuardia Airport (LGA), and the Newark Liberty International Airport (EWR). Any trip that satifies the following criteria is defined as an aiport trip.

- RateCodeID of 2 (JFK) or 3 (EWR)  
- Dropoff at JFK, LGA or EWR zone  

```{r identify_airport_trips}
# find airport zones from all taxi zones
airport_zones <- taxi_zones@data %>%
  filter(service_zone %in% c("Airports", "EWR")) %>%
  select(OBJECTID, zone)

# identify airport trips
trips_data[, 
  Airport_trip := Dropoff_location %in% airport_zones$OBJECTID | RateCodeID %in% c(2, 3)]


cat(paste(
  sum(trips_data$Airport_trip), "trips defined as airport trips")
)
```


We also need to preprocess datetime to extract the exact hour of day and day of week. The datetime attribute is then replaced by just date for use in analysis coupled with weather data. Resultant of preprocessed dataframe is shown below
```{r preprocess_date}
trips_data[, Pickup_day := wday(Pickup_datetime, label=TRUE)]
trips_data[, Pickup_hour := hour(Pickup_datetime)]
trips_data[, Pickup_datetime := as_date(Pickup_datetime)]


# identify day trips and night trips
trips_data[, Time := ifelse(Pickup_hour >= 6 & Pickup_hour < 18,
                            "Daytime",
                            "Nighttime") %>% as.factor()]

# convert to tibble for ggplot
trips_data <- as_tibble(trips_data) %>%
  rename(Pickup_date = Pickup_datetime) %>%
  select(-c(Dropoff_datetime, Passenger_count, 
            Dropoff_latitude, Dropoff_longitude, RateCodeID))

glimpse(trips_data)
```


Checkpoint here  
```{r save_load}
# Uncomment to save or load the preprocessed dataframe
#saveRDS(trips_data, file="data/trips_data.rds")
#trips_data <- readRDS("data/trips_data.rds")
```


----------------------------------------------------------------------------------------------------------

# Findings and Analysis


## What affects tipping
```{r distance_vs_vars, fig.cap="This is distance vs variables"}
# Trip distance vs Tipping
n <- 100
trips_data %>%
  filter(Payment_type == 1) %>%
  mutate(Bin = cut_number(Trip_distance, n)) %>%
  group_by(Bin) %>%
  summarise(Trip_distance = mean(Trip_distance),
            Number = n(),
            Tip_amount = mean(Tip_amount),
            Total_amount = mean(Total_amount),
            Tipping_percentage = mean(Tip_amount / Total_amount),
            Trip_duration = mean(Trip_duration)) %>%
  ungroup() %>%
  gather(Tip_amount:Trip_duration, key="Measure", value="Value") %>%
  ggplot(aes(x=Trip_distance, y=Value, color=Number)) +
  geom_point() +
  facet_wrap(Measure ~ ., scales="free_y") +
  theme_bw() +
  labs(title="Relationship of trip distance with other variables")


```

```{r timeday_vs_tippercent, fig.cap="This is timeday vs tipping percentage"}
# Time and day vs Tipping percentage
trips_data %>%
  filter(Payment_type == 1) %>%
  group_by(Season, Pickup_day, Pickup_hour) %>%
  summarise(Tipping_percentage = mean(Tip_amount / Total_amount)) %>%
  ggplot(aes(x=Pickup_day, y=Pickup_hour, fill=Tipping_percentage)) +
  geom_tile() +
  scale_fill_distiller(palette="Spectral") +
  scale_y_continuous(breaks=seq(0, 23)) +
  facet_grid(. ~ Season) +
  theme_bw() +
  labs(x="Day of the week", y="Hour of the day",
       title="Tipping percentage at different times of days")


```

```{r zones_tippercent, fig.cap="This is zones vs tipping percentage"}
#taxi_zones@data <- taxi_zones@data %>% select(-c(Tipping_percentage))
# Zones with pickups with most tipping percentage
taxi_zones@data <- taxi_zones@data %>%
  left_join(
    trips_data %>%
      group_by(Pickup_location) %>%
      summarise(Tipping_percentage = mean(Tip_amount / Total_amount)),
    by=c("OBJECTID"="Pickup_location"))

# qtm(shp=taxi_zones, fill = "Tipping_percentage", fill.palette = "Blues") +
#   tm_legend(main.title = "Ratio of tips to total amount for each pickup taxi zone",
#             main.title.size = 1)

map <- get_stamenmap(as.numeric(bbox(taxi_zones)), zoom=10)
ggmap(map) +
  geom_polygon(data=fortify(taxi_zones) %>%
                 left_join(taxi_zones@data),
               aes(x=long, y=lat, group=group, fill=Tipping_percentage)) +
  scale_fill_distiller(palette='Spectral') + 
  labs(x="Longitude", y="Latitude",
       title="Percent of tips to total amount for each pickup taxi zone")
```
Zones with highest tipping percentage
1                      Hudson Sq          0.2603203
2         Charleston/Tottenville          0.2258583
3 Stuy Town/Peter Cooper Village          0.2000000
4                  Arden Heights          0.1999171  


referencing figure 1 here \@ref(fig:distance_vs_vars)  
referencing figure 2 here \@ref(fig:timeday_vs_tippercent)  

## What affects usage of taxi

```{r daytrip_vs_nighttrip, fig.cap="This is daytrip vs nighttrip"}
# Day trip and night trip
trips_data %>%
  group_by(Season, Pickup_day, Time) %>%
  summarise(Num_trips = n()) %>%
  ungroup() %>%
  ggplot(aes(x=Pickup_day, y=Num_trips, fill=Time)) +
  geom_bar(stat="identity", position=position_dodge(), colour="black") +
  facet_grid(. ~ Season) +
  theme_bw() +
  labs(x="Day of the week", y="Number of taxi trips",
       title="Taxi pickups in daytime and nighttime across days of week")

```

```{r timeday_vs_numtrips, fig.cap="This is time and day vs number of trips"}
# Time and day
trips_data %>%
  group_by(Season, Pickup_day, Pickup_hour) %>%
  summarise(Num_trips = n()) %>%
  ungroup() %>%
  ggplot(aes(x=Pickup_day, y=Pickup_hour, fill=Num_trips)) +
  geom_tile() +
  scale_fill_distiller(palette="Spectral") +
  scale_y_continuous(breaks=seq(0, 23)) +
  facet_grid(. ~ Season) +
  theme_bw() +
  labs(x="Day of the week", y="Hour of the day",
       title="Taxi pickups at different times of days")

```

```{r daynight_vs_longtrip, fig.cap="This is daynight vs long trip"}
# How likely to get long trip in daytime and nighttime
long_trip <- as.numeric(quantile(trips_data$Trip_distance, 0.75))
trips_data %>%
  group_by(Pickup_day, Time) %>%
  summarise(Long_trips = mean(Trip_distance > long_trip)) %>%
  ungroup() %>%
  ggplot(aes(x=Pickup_day, y=Long_trips, fill=Time)) +
  geom_bar(stat="identity", position=position_dodge(), colour="black") +
  theme_bw() +
  labs(x="Day of the week", y="Probability of long trip",
       title=paste0("How likely to get a long trip (>", long_trip, " miles)"))

```

```{r zones_vs_numtrips, fig.cap="This is zones vs number of trips"}
#taxi_zones@data <- taxi_zones@data %>% select(-c(Daytime, Nighttime))
# Zones with most trips in daytime and nighttime
taxi_zones@data <- taxi_zones@data %>%
  left_join(
    trips_data %>%
      group_by(Time, Pickup_location) %>%
      summarise(Num_trips = n()) %>%
      spread(key=Time, value=Num_trips),
    by=c("OBJECTID"="Pickup_location"))

qtm(shp=taxi_zones, fill = c("Daytime", "Nighttime"), fill.palette = "Blues", ncol = 2) +
  tm_legend(main.title = "Frequency of pickups in daytime and nighttime for each taxi zone",
            main.title.size = 1)

```

Zones with most pickup in daytime:
1   East Harlem North  263803
2   East Harlem South  261508
3      Central Harlem  243942
4 Morningside Heights  193691

Zones with most pickup in nighttime:
1 Williamsburg (North Side)    340581
2                   Astoria    244592
3                  Elmhurst    217167
4            Central Harlem    207715

East Harlem South and Morningside Heights have more pickups in daytime than in nighttime.
Williamsbug North and South have more pickups in nighttime than in daytime.

```{r distance_vs_hour, fig.cap="This is "}
# Trip distance by hour of day
trips_data %>%
  group_by(Pickup_hour) %>%
  summarise(Mean = mean(Trip_distance),
            Median = median(Trip_distance)) %>%
  ungroup() %>%
  gather(Mean:Median, key="Trip_distance", value="Value") %>%
  ggplot(aes(x=Pickup_hour, y=Value)) +
  geom_line(aes(color=Trip_distance, linetype=Trip_distance), size=1) +
  theme_bw() +
  labs(x="Pickup hour", y="Distance in miles",
       title="Mean and median trip distance by hour of day")

```

```{r hour_vs_airport, fig.cap="This is "}
# Percentage of airport trips per hour
trips_data %>%
  group_by(Pickup_hour) %>%
  summarise(Airport_percent = mean(Airport_trip)) %>%
  ungroup() %>%
  ggplot(aes(x=Pickup_hour, y=Airport_percent)) +
  geom_bar(stat="identity") +
  theme_bw() +
  labs(x="Pickup hour", y="Percent of trips to airport",
       title="Percent of trips to airport by hour of day")

```

```{r zones_vs_airport, fig.cap="This "}
# Zones with most trips to one of three airports
taxi_zones@data <- taxi_zones@data %>%
  left_join(
    trips_data %>%
      filter(Airport_trip) %>%
      group_by(Pickup_location) %>%
      summarise(Airport_trips = n()) %>%
      ungroup(),
    by=c("OBJECTID"="Pickup_location"))



qtm(shp=taxi_zones, fill = "Airport_trips", fill.palette = "Blues") +
  qtm(taxi_zones[taxi_zones$zone %in% airport_zones$zone,], fill="red") +
  tm_legend(main.title = "Frequency of trips to airport at each taxi zone",
            main.title.size = 1)
```
Mean distances were constantly higher than median distance during each hour. This is most likely because the distribution of trip distance is right-skewed, and the mean could be inflated by a few long-distance trips. As such, the median is a fairer representation of the central tendency of all distances.  

the distance of a typical green taxi trip fluctuated around 2 miles during most time of the day. Trips started during 4:00 PM to 6:00 PM tended to be the shortest, and trips started between 4:00 AM and 6:00 AM were the longest. The surge in long-distance trips during the morning is likely driven by trips to the airports or other long-distance rides. As shown above, the sudden increase in percent of taxi rides to airport closely matches the increase in hourly mean and median distance.

223                       Steinway         12471
7                          Astoria         11262
82                        Elmhurst          8701
129                Jackson Heights          8475

```{r weather_vs_numtrips, fig.cap="This is "}
# Weather vs Number of trips
trips_data %>%
  group_by(Season, Pickup_date) %>%
  summarise(Num_trips = n()) %>%
  ungroup() %>%
  left_join(weather, by=c("Pickup_date" = "DATE")) %>%
  gather(AWND:AVG_T, key="Measure", value="Value") %>%
  ggplot(aes(x=Value, y=Num_trips, color=Season)) +
  geom_point() +
  geom_smooth(method=lm) +
  facet_wrap(Measure ~ ., scales="free_x") +
  labs(x="Value of measurement", y="Frequency of pickups",
       title="Weather condition vs frequency of pickups of every day")

```

```{r weather_vs_distance, fig.cap="This is"}
# Weather vs Trip distance
trips_data %>%
  group_by(Season, Pickup_date) %>%
  summarise(Trip_distance = mean(Trip_distance)) %>%
  ungroup() %>%
  left_join(weather, by=c("Pickup_date" = "DATE")) %>%
  gather(AWND:AVG_T, key="Measure", value="Value") %>%
  ggplot(aes(x=Value, y=Trip_distance, color=Season)) +
  geom_point() +
  geom_smooth(method=lm) +
  facet_wrap(Measure ~ ., scales="free_x") +
  labs(x="Value of measurement", y="Trip distance in miles",
       title="Weather condition vs mean trip distance of every day")
```



----------------------------------------------------------------------------------------------------------

# Conclusion  

This is conclusion